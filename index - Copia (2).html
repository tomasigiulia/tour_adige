<!DOCTYPE html>
<html lang="it">
<head>
    <title>Tour 360</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --success-color: #27ae60;
            --bg-overlay: rgba(44, 62, 80, 0.95);
            --bg-light: rgba(255, 255, 255, 0.95);
            --shadow: 0 4px 20px rgba(0,0,0,0.15);
            --shadow-hover: 0 6px 30px rgba(0,0,0,0.25);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #1a1a1a; 
            color: #333; 
            overflow: hidden; 
        }
        #pano { position: absolute; width: 100%; height: 100%; background: #000; }
        
        #title { 
            position: absolute; top: 15px; left: 15px; 
            font-size: clamp(16px, 3vw, 22px);
            z-index: 1001; 
            background: var(--bg-overlay);
            color: white;
            padding: 10px 20px; 
            border-radius: 12px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        #map-box { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            width: min(350px, 90vw); 
            height: min(350px, 40vh); 
            border: 2px solid var(--primary-color);
            border-radius: 15px; 
            box-shadow: var(--shadow);
            overflow: hidden; 
            z-index: 1001; 
            background: var(--bg-overlay);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        #map-box.collapsed {
            width: 45px;
            height: 45px;
            overflow: visible;
            border-radius: 50%;
        }
        #map-box.collapsed #map-toggle {
            bottom: 50%;
            right: 50%;
            transform: translate(50%, 50%);
        }
        #mapContainer { width: 100%; height: 100%; }
        #map-box.collapsed #mapContainer { display: none; }
        
        #map-toggle {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary-color);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            line-height: 1;
            padding-top: 1px;
        }
        #map-toggle:hover {
            background: var(--accent-hover);
            transform: scale(1.1);
        }
        
        .leaflet-control-layers {
            background: var(--bg-light) !important;
            border-radius: 8px !important;
            border: 2px solid var(--primary-color) !important;
        }

        #controls-wrapper {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0;
            z-index: 1001;
            transition: transform 0.3s ease;
        }
        #controls-wrapper.collapsed {
            transform: translateY(calc(100% - 45px));
        }

        #controls { 
            display: flex; 
            gap: 10px; 
            background: rgba(44, 62, 80, 0.5);
            padding: 15px; 
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px);
            overflow-x: auto;
            overflow-y: hidden;
            justify-content: center;
            flex-wrap: nowrap;
        }
        #controls::-webkit-scrollbar {
            height: 6px;
        }
        #controls::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
        }

        #controls-toggle {
            width: 100%;
            background: rgba(44, 62, 80, 0.75);
            color: white;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(8px);
        }
        #controls-toggle:hover {
            background: rgba(44, 62, 80, 0.9);
        }

        button.scene-btn { 
            background: white; 
            border: 2px solid var(--primary-color);
            border-radius: 10px; 
            cursor: pointer; 
            width: 90px;
            min-width: 90px;
            transition: all 0.3s; 
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button.scene-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }
        button.scene-btn.active { 
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }
        .btn-preview { width: 100%; height: 50px; object-fit: cover; display: block; }
        .btn-label { 
            font-size: 10px; 
            padding: 5px; 
            font-weight: 600; 
            text-transform: uppercase;
            background: var(--primary-color);
            color: white;
        }
        
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-light);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
            font-size: 24px;
            color: var(--primary-color);
            font-weight: bold;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        .nav-arrow:hover { 
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white; 
            transform: translateY(-50%) scale(1.15);
            box-shadow: var(--shadow-hover);
        }
        .nav-arrow.left { left: 15px; }
        .nav-arrow.right { right: 15px; }
        .nav-arrow:disabled { 
            opacity: 0.3; 
            cursor: not-allowed;
            transform: translateY(-50%) scale(1);
        }
        .nav-arrow:disabled:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #title { font-size: 16px; padding: 8px 15px; }
            #map-box { 
                width: calc(100% - 30px);
                height: 250px;
                top: 10px;
                right: 15px;
            }
            #controls { padding: 10px; gap: 8px; }
            button.scene-btn { width: 75px; min-width: 75px; }
            .btn-preview { height: 40px; }
            .nav-arrow { 
                width: 45px; 
                height: 45px; 
                font-size: 20px;
            }
            .nav-arrow.left { left: 10px; }
            .nav-arrow.right { right: 10px; }
        }

        @media (max-width: 480px) {
            #title { font-size: 14px; padding: 6px 12px; }
            #map-box { height: 200px; }
            button.scene-btn { width: 65px; min-width: 65px; }
            .btn-preview { height: 35px; }
            .btn-label { font-size: 8px; padding: 3px; }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            #map-box { 
                width: 250px;
                height: 250px;
            }
            #controls { padding: 8px; }
            .nav-arrow {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>

<div id="pano"></div>
<div id="title">TOUR 360Â°</div>

<div id="map-box">
    <div id="mapContainer"></div>
    <button id="map-toggle" onclick="toggleMap()" title="Mostra/Nascondi mappa">â–¼</button>
</div>

<div id="controls-wrapper">
    <button id="controls-toggle" onclick="toggleControls()">â–² MOSTRA/NASCONDI FOTO â–²</button>
    <div id="controls"></div>
</div>

<button class="nav-arrow left" id="prevBtn" onclick="navigateScene(-1)">â—„</button>
<button class="nav-arrow right" id="nextBtn" onclick="navigateScene(1)">â–º</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="marzipano.js"></script>

<script>
const panoramaFiles = ['panorama1.jpg', 'panorama2.jpg', 'panorama3.jpg'];
const folder = 'panorami/';

var viewer = new Marzipano.Viewer(document.getElementById('pano'));
var scenes = [];
var markers = [];
var map;
var currentView;
var currentSceneIndex = 0;

// Autorotazione
var autorotate = Marzipano.autorotate({ yawSpeed: 0.03, targetPitch: 0, targetFov: Math.PI/2 });

function convertToDecimal(ref, deg, min, sec) {
    var factor = (ref === 'S' || ref === 'W') ? -1 : 1;
    return factor * (deg + (min / 60) + (sec / 3600));
}

function getGpsData(url) {
    return new Promise((resolve) => {
        var img = new Image();
        img.onload = function() {
            EXIF.getData(img, function() {
                var lat = EXIF.getTag(this, "GPSLatitude");
                var latRef = EXIF.getTag(this, "GPSLatitudeRef");
                var lng = EXIF.getTag(this, "GPSLongitude");
                var lngRef = EXIF.getTag(this, "GPSLongitudeRef");
                if (lat && lng) {
                    resolve({
                        lat: convertToDecimal(latRef, lat[0], lat[1], lat[2]),
                        lng: convertToDecimal(lngRef, lng[0], lng[1], lng[2])
                    });
                } else { resolve(null); }
            });
        };
        img.src = url;
    });
}

async function init() {
    let locations = [];
    for (let file of panoramaFiles) {
        let coords = await getGpsData(folder + file);
        if (coords) locations.push({ ...coords, file: file });
    }

    if (locations.length === 0) {
        alert("Nessun dato GPS trovato nelle foto!"); return;
    }

    // MAPPA con vista satellitare
    map = L.map('mapContainer', { zoomControl: true, attributionControl: false });
    
    // Layer satellitare
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20
    });
    
    // Layer stradale
    var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    });
    
    // Layer ibrido (satellitare + etichette)
    var labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/only_labels/{z}/{x}/{y}.png', {
        maxZoom: 20
    });
    
    // Aggiungi layer satellitare di default
    satellite.addTo(map);
    labels.addTo(map);
    
    // Controllo layer
    var baseMaps = {
        "ðŸ›°ï¸ Satellite": L.layerGroup([satellite, labels]),
        "ðŸ—ºï¸ Stradale": streets
    };
    L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
    
    // Imposta lo zoom per mostrare tutti i punti
    var bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lng]));
    map.fitBounds(bounds, { padding: [60, 60] });

    locations.forEach((data, index) => {
        var source = Marzipano.ImageUrlSource.fromString(folder + data.file);
        var geometry = new Marzipano.EquirectGeometry([{ width: 4096 }]);
        var limiter = Marzipano.RectilinearView.limit.traditional(4096, 100*Math.PI/180);
        var view = new Marzipano.RectilinearView({ yaw: 0, pitch: 0, fov: Math.PI/2 }, limiter);
        var scene = viewer.createScene({ source: source, geometry: geometry, view: view });
        scenes.push({scene, view, lat: data.lat, lng: data.lng});

        // Marker posizione con numero
        var marker = L.circleMarker([data.lat, data.lng], { 
            radius: 10, 
            fillColor: "#3498db", 
            color: "#fff", 
            weight: 3, 
            fillOpacity: 0.9 
        }).addTo(map);
        
        // Aggiungi numero al marker
        var icon = L.divIcon({
            className: 'number-icon',
            html: `<div style="color: white; font-weight: bold; font-size: 12px; 
                    text-align: center; line-height: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); 
                    cursor: pointer;">
                    ${index + 1}</div>`,
            iconSize: [20, 20]
        });
        var numMarker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
        numMarker.on('click', () => switchScene(index));
        
        marker.on('click', () => switchScene(index));
        markers.push(marker);

        var btn = document.createElement('button');
        btn.className = 'scene-btn';
        btn.id = 'btn' + index;
        btn.innerHTML = `<img src="${folder + data.file}" class="btn-preview"><div class="btn-label">Punto ${index+1}</div>`;
        btn.onclick = () => switchScene(index);
        document.getElementById('controls').appendChild(btn);
    });

    switchScene(0);
}

function switchScene(index) {
    var data = scenes[index];
    data.scene.switchTo({ transitionDuration: 500 });
    currentView = data.view;
    currentSceneIndex = index;
    
    map.panTo([data.lat, data.lng]);
    
    // Evidenzia marker corrente
    markers.forEach((m, i) => {
        if (i === index) {
            m.setStyle({ radius: 12, fillColor: "#27ae60", weight: 4 });
        } else {
            m.setStyle({ radius: 10, fillColor: "#3498db", weight: 3 });
        }
    });
    
    // Attiva rotazione automatica
    viewer.startMovement(autorotate);
    viewer.setIdleMovement(3000, autorotate);

    // Update UI
    document.querySelectorAll('#controls .scene-btn').forEach((b, i) => b.classList.toggle('active', i === index));
    updateNavigationButtons();
}

function navigateScene(direction) {
    var newIndex = currentSceneIndex + direction;
    if (newIndex >= 0 && newIndex < scenes.length) {
        switchScene(newIndex);
    }
}

function updateNavigationButtons() {
    document.getElementById('prevBtn').disabled = (currentSceneIndex === 0);
    document.getElementById('nextBtn').disabled = (currentSceneIndex === scenes.length - 1);
}

function toggleMap() {
    var mapBox = document.getElementById('map-box');
    var toggleBtn = document.getElementById('map-toggle');
    mapBox.classList.toggle('collapsed');
    toggleBtn.textContent = mapBox.classList.contains('collapsed') ? 'ðŸŒ' : 'Ã—';
    toggleBtn.title = mapBox.classList.contains('collapsed') ? 'Apri mappa' : 'Chiudi mappa';
    
    // Aggiorna la mappa quando viene espansa
    if (!mapBox.classList.contains('collapsed')) {
        setTimeout(() => {
            map.invalidateSize();
            // Mostra tutti i marker con zoom adattivo
            var bounds = L.latLngBounds(scenes.map(s => [s.lat, s.lng]));
            map.fitBounds(bounds, { padding: [60, 60] });
        }, 300);
    }
}

function toggleControls() {
    var wrapper = document.getElementById('controls-wrapper');
    var toggleBtn = document.getElementById('controls-toggle');
    wrapper.classList.toggle('collapsed');
    toggleBtn.textContent = wrapper.classList.contains('collapsed') ? 
        'â–² MOSTRA FOTO â–²' : 'â–¼ NASCONDI FOTO â–¼';
}

init();
</script>
</body>
</html>