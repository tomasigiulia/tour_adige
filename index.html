<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Tour 360 Pro - Coordinate Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
/* Stili base identici a quelli vecchi + hotspot Sycius */
body, html { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
#pano { position:absolute; width:100%; height:100%; cursor:crosshair; touch-action:none; }
#title { position:absolute; top:20px; left:20px; background:rgba(44,62,80,0.9); color:#fff; padding:12px 20px; border-radius:10px; font-weight:bold; backdrop-filter:blur(10px); z-index:1001; }

/* MAPPA */
#map-box { position:absolute; top:20px; right:20px; width:320px; height:260px; z-index:1001; border-radius:14px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.06); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
#mapContainer { width:100%; height:100%; }
.map-controls { position:absolute; top:10px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:1002; }
.map-btn { width:38px; height:38px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.45); color:#fff; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.map-btn:hover { background:rgba(255,255,255,0.06); transform:translateY(-2px); }

/* HOTSPOT */
.hotspot-info { width:34px; height:34px; border-radius:50%; background:linear-gradient(180deg,#0b3d91,#082b5f); border:2px solid rgba(255,255,255,0.12); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; position:absolute; margin-left:-17px; margin-top:-17px; cursor:pointer; z-index:10010; box-shadow:0 6px 18px rgba(11,61,145,0.24); transition: transform 0.12s ease; }
.hotspot-info:hover { transform:scale(1.08); box-shadow:0 10px 22px rgba(11,61,145,0.28); }

/* GALLERY */
#controls-wrapper { position:absolute; bottom:0; width:100%; z-index:1001; background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); }
#controls { display:flex; gap:10px; padding:15px; justify-content:center; overflow-x:auto; }
.scene-btn { width:80px; border-radius:6px; border:2px solid transparent; cursor:pointer; background:#222; flex-shrink:0; }
.scene-btn.active { border-color:#3498db; }
.scene-btn img { width:100%; height:40px; object-fit:cover; display:block; }
.btn-label { font-size:9px; color:white; padding:3px; text-align:center; }

/* ROTATION TOGGLE */
#rotation-toggle { display:inline-flex; align-items:center; justify-content:center; width:42px; height:36px; margin-left:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.08); background:transparent; color:#fff; cursor:pointer; font-size:18px; line-height:1; }
#rotation-toggle.locked { border-color:#3498db; color:#3498db; }

/* MODALE HOTSPOT */
#info-modal { position:fixed; inset:0; z-index:20000; display:none; }
#info-modal .info-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.6); }
#info-modal .info-content { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(760px,calc(100%-40px)); background:linear-gradient(180deg,#0f0f12,#111217); color:#fff; padding:14px 16px; border-radius:10px; box-shadow:0 20px 60px rgba(0,0,0,0.6); }
#info-modal .info-close { position:absolute; right:10px; top:10px; background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer; }
#info-modal .info-flex { display:flex; gap:14px; align-items:flex-start; }
#info-modal .info-text { flex:1 1 60%; }
#info-modal .info-image { flex:0 0 180px; display:none; }
#info-modal .info-image img { width:100%; height:auto; border-radius:6px; display:block; }
#info-modal h3 { margin:2px 0 8px 0; font-size:16px; }
#info-modal #info-body { font-size:13px; color:#ddd; white-space:pre-wrap; }
</style>
</head>
<body>

<div id="pano"></div>
<div id="title">VIRTUAL TOUR 360¬∞</div>

<div id="map-box">
    <div id="mapContainer"></div>
    <div class="map-controls">
        <button class="map-btn" onclick="zoomIn()">+</button>
        <button class="map-btn" onclick="zoomOut()">‚àí</button>
        <button class="map-btn" onclick="toggleLayer()">üó∫Ô∏è</button>
    </div>
</div>

<div id="controls-wrapper">
    <div id="controls"></div>
    <button id="rotation-toggle" onclick="toggleRotation(event)">üîÑ</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="./marzipano.js"></script>
<script src="./data.js"></script>

<script>
const panoramaFiles = ['panorama1.jpg','panorama2.jpg','panorama3.jpg'];
const folder = './panorami/';

let viewer = new Marzipano.Viewer(document.getElementById('pano'));
let scenes=[], markers=[], map, currentView, currentSceneIndex=0;
let autorotate = Marzipano.autorotate({yawSpeed:0.03,targetPitch:0});
let rotationLocked=false, rotationTimer=null;
let baseLayer,satelliteLayer,layers=[],currentLayerIndex=0;

// INIZIALIZZA MAPPA
function initMap() {
    map = L.map('mapContainer',{zoomControl:false,attributionControl:false});
    baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' });
    satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ attribution:'Esri' });
    layers = [baseLayer, satelliteLayer];
    layers[0].addTo(map);
}

// LAYER
function toggleLayer() {
    map.removeLayer(layers[currentLayerIndex]);
    currentLayerIndex=(currentLayerIndex+1)%layers.length;
    layers[currentLayerIndex].addTo(map);
}

// ZOOM
function zoomIn(){ map.zoomIn(); }
function zoomOut(){ map.zoomOut(); }

// CREAZIONE SCENE
function createScenes() {
    panoramaFiles.forEach((file,index)=>{
        let source=Marzipano.ImageUrlSource.fromString(folder+file);
        let geometry= new Marzipano.EquirectGeometry([{width:4000}]);
        let limiter=Marzipano.RectilinearView.limit.traditional(4000,100*Math.PI/180);
        let view = new Marzipano.RectilinearView({yaw:0,pitch:0,fov:Math.PI/2},limiter);
        let scene = viewer.createScene({source,geometry,view});
        scenes.push({scene,view,hotspotsCreated:false});
        
        // Marker su mappa
        let marker = L.circleMarker([45+index*0.001,10+index*0.001], {radius:7, fillColor:"#3498db", color:"#fff", weight:2, fillOpacity:1}).addTo(map);
        marker.on('click',()=>switchScene(index));
        markers.push(marker);

        // Pulsante galleria
        let btn = document.createElement('button'); btn.className='scene-btn';
        btn.innerHTML=`<img src="${folder+file}"><div class="btn-label">Punto ${index+1}</div>`;
        btn.onclick=()=>switchScene(index);
        document.getElementById('controls').appendChild(btn);
    });

    map.fitBounds(L.latLngBounds(markers.map(m=>m.getLatLng())),{padding:[30,30]});
}

// SWITCH SCENA
function switchScene(index){
    let data = scenes[index];
    data.scene.switchTo({transitionDuration:1000});
    currentView=data.view;
    currentSceneIndex=index;
    map.panTo(markers[index].getLatLng());
    markers.forEach((m,i)=>m.setStyle({fillColor:i===index?"#27ae60":"#3498db"}));
    document.querySelectorAll('.scene-btn').forEach((b,i)=>b.classList.toggle('active',i===index));
    addHotspots(index);
    if(!rotationLocked){ startAutoRotation(); } else { stopAutoRotation(); }
}

// HOTSPOT SYCIUS
function addHotspots(index){
    if(index!==0) return;
    if(scenes[index].hotspotsCreated) return;
    let hsData={yaw:0.5,pitch:0.1,title:"Sycius",text:"Testo descrizione Sycius",image:"./panorami/sycius.jpg"};
    let el=document.createElement('div'); el.className='hotspot-info'; el.innerHTML='<span class="hotspot-plus">+</span>';
    el.onclick=()=>showInfoHotspot(hsData.title,hsData.text,hsData.image);
    scenes[index].scene.hotspotContainer().createHotspot(el,{yaw:hsData.yaw,pitch:hsData.pitch});
    scenes[index].hotspotsCreated=true;
}

// ROTAZIONE
function stopAutoRotation(){ viewer.stopMovement(); try{ viewer.setIdleMovement(false); }catch(e){} }
function startAutoRotation(){ viewer.startMovement(autorotate); viewer.setIdleMovement(3000,autorotate); }
document.getElementById('pano').addEventListener('mousedown',stopAutorotateTemp);
document.getElementById('pano').addEventListener('touchstart',stopAutorotateTemp);
function stopAutorotateTemp(){
    stopAutoRotation(); rotationLocked=true;
    if(rotationTimer) clearTimeout(rotationTimer);
    rotationTimer=setTimeout(()=>{ rotationLocked=false; startAutoRotation(); updateRotationButton(); },60000);
    updateRotationButton();
}

// PULSANTE ROTAZIONE
function toggleRotation(e){ e.stopPropagation(); if(rotationLocked){ rotationLocked=false; startAutoRotation(); } else { rotationLocked=true; stopAutoRotation(); } updateRotationButton(); }
function updateRotationButton(){ document.getElementById('rotation-toggle').classList.toggle('locked',rotationLocked); }

// MODALE HOTSPOT
function showInfoHotspot(title,text,imageUrl){
    var existing=document.getElementById('info-modal'); 
    if(!existing){ 
        let modal=document.createElement('div'); modal.id='info-modal'; 
        modal.innerHTML=`<div class="info-backdrop" onclick="hideInfoHotspot()"></div>
            <div class="info-content"><button class="info-close" onclick="hideInfoHotspot()">‚úï</button>
            <h3 id="info-title"></h3><div id="info-body"></div><img id="info-image" style="max-width:300px; display:block; margin-top:10px;" /></div>`;
        document.body.appendChild(modal);
    }
    document.getElementById('info-title').innerText=title||'';
    document.getElementById('info-body').innerText=text||'';
    let img=document.getElementById('info-image');
    if(imageUrl){ img.src=imageUrl; img.style.display='block'; } else{ img.src=''; img.style.display='none'; }
    document.getElementById('info-modal').style.display='block';
}
function hideInfoHotspot(){ document.getElementById('info-modal').style.display='none'; }

// INIT
initMap(); createScenes(); switchScene(0);
</script>
</body>
</html>
